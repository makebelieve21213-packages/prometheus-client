name: Publish to npm

on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # Для npm provenance

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Нужно для получения тегов
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.x"
          registry-url: "https://registry.npmjs.org"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Fix linter issues
        run: pnpm lint:fix

      - name: Fix formatting
        run: pnpm format:fix

      - name: Commit fixes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "chore: auto-fix linting and formatting issues [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi

      - name: Build
        run: pnpm build

      - name: Run tests
        run: pnpm test:coverage

      - name: Update package.json version
        run: |
          # Получаем тег из события релиза
          TAG_NAME="${{ github.event.release.tag_name }}"
          
          # Если тег пустой, пробуем получить из GITHUB_REF
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "Using GITHUB_REF tag: $TAG_NAME"
          else
            echo "Using release tag: $TAG_NAME"
          fi
          
          if [ -z "$TAG_NAME" ]; then
            echo "ERROR: Cannot determine release tag!"
            echo "GITHUB_REF: $GITHUB_REF"
            echo "github.event.release.tag_name: ${{ github.event.release.tag_name }}"
            exit 1
          fi
          
          # Удаляем префикс 'v' если есть (v1.0.2 -> 1.0.2)
          VERSION=${TAG_NAME#v}
          
          if [ -z "$VERSION" ]; then
            echo "ERROR: Version is empty after removing 'v' prefix!"
            echo "Original tag: $TAG_NAME"
            exit 1
          fi
          
          echo "Updating package.json version to: $VERSION"
          
          # Обновляем версию в package.json через переменную окружения
          VERSION="$VERSION" node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const newVersion = process.env.VERSION;
            if (!newVersion) {
              console.error('ERROR: VERSION environment variable is not set');
              process.exit(1);
            }
            console.log('Current version:', pkg.version);
            console.log('New version:', newVersion);
            pkg.version = newVersion;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('✅ Updated version to:', newVersion);
          "
          
          # Проверяем что версия обновилась
          ACTUAL_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "Actual package.json version: $ACTUAL_VERSION"
          
          if [ "$ACTUAL_VERSION" != "$VERSION" ]; then
            echo "ERROR: Version mismatch! Expected: $VERSION, Got: $ACTUAL_VERSION"
            exit 1
          fi
          
          echo "✅ Successfully updated version to $VERSION"

      - name: Publish to npm
        run: pnpm publish --access public --no-git-checks --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
