# @makebelieve21213-packages/prometheus-client - Документация для ИИ

## Краткое описание

ESM пакет для работы с Prometheus метриками в NestJS приложениях. Интегрируется с @willsoto/nestjs-prometheus для автоматического экспорта метрик на `/metrics` endpoint. Предоставляет type-safe API для создания Counter, Histogram, Gauge и Summary метрик. **Global Module** - регистрируется один раз и доступен во всех модулях. Включает специализированные сервисы для HTTP, Kafka и AI метрик, автоматический HTTP интерцептор, декораторы для трекинга и утилиты для работы с метриками.

## Архитектура

Пакет предоставляет:
- **PrometheusClientModule** - глобальный NestJS модуль для регистрации
- **PrometheusService** - базовый сервис для создания метрик
- **HttpMetricsService** - сервис для HTTP метрик
- **KafkaMetricsService** - сервис для Kafka метрик
- **AiMetricsService** - сервис для AI метрик
- **PrometheusHttpInterceptor** - HTTP интерцептор для автоматического сбора метрик
- **Декораторы** - @TrackDuration, @TrackCounter, @PrometheusMetric

## Структура пакета

```
src/
├── main/
│   ├── prometheus.module.ts            # NestJS модуль (Global)
│   └── prometheus.service.ts           # Базовый сервис для работы с метриками
├── services/
│   ├── http-metrics.service.ts         # Сервис для HTTP метрик
│   ├── kafka-metrics.service.ts        # Сервис для Kafka метрик
│   └── ai-metrics.service.ts           # Сервис для AI метрик
├── interceptors/
│   └── prometheus-http.interceptor.ts  # HTTP интерцептор для автоматического сбора метрик
├── decorators/
│   ├── prometheus-metric.decorator.ts  # Декоратор для кастомных метрик
│   ├── track-duration.decorator.ts     # Декоратор для измерения времени
│   └── track-counter.decorator.ts      # Декоратор для подсчета вызовов
├── utils/
│   ├── injection-keys.ts               # Injection tokens для DI
│   ├── metric-labels.ts                # Утилиты для работы с метками
│   ├── metric-registry.ts              # Реестр предопределенных метрик
│   ├── metric-sets.ts                  # Предопределенные наборы метрик
│   ├── metric-timer.ts                 # Утилита для измерения времени
│   └── metric-wrapper.ts               # Обертка для функций с метриками
├── types/
│   ├── module-options.interface.ts     # Опции конфигурации модуля
│   ├── prometheus.interface.ts         # Интерфейс PrometheusClientContract
│   ├── metric-sets.interface.ts        # Интерфейсы наборов метрик
│   ├── metric-wrapper.interface.ts     # Интерфейс опций обертки функций
│   └── prometheus-metric.interface.ts  # Интерфейс конфигурации декоратора метрик
└── index.ts                            # Экспорты пакета
```

## Основные компоненты

### PrometheusService (базовый сервис)

Использует глобальный `Registry` от `prom-client` для совместимости с @willsoto/nestjs-prometheus.

Методы:
- `createCounter(config)` - создание Counter метрики
- `createHistogram(config)` - создание Histogram метрики
- `createGauge(config)` - создание Gauge метрики
- `createSummary(config)` - создание Summary метрики
- `getRegistry()` - получение Registry

### Специализированные сервисы

- **HttpMetricsService** - автоматически создает и управляет HTTP метриками
  - `http_requests_total` (Counter)
  - `http_request_duration_seconds` (Histogram)
  - `http_request_size_bytes` (Histogram)
  - `http_response_size_bytes` (Histogram)
  - `http_errors_total` (Counter)
- **KafkaMetricsService** - автоматически создает и управляет Kafka метриками
  - `kafka_messages_total` (Counter)
  - `kafka_message_duration_seconds` (Histogram)
  - `kafka_errors_total` (Counter)
- **AiMetricsService** - автоматически создает и управляет AI метриками
  - `ai_stream_requests_total` (Counter)
  - `ai_stream_duration_seconds` (Histogram)
  - `ai_stream_tokens_total` (Counter)
  - `ai_requests_total` (Counter)
  - `ai_request_duration_seconds` (Histogram)

### PrometheusHttpInterceptor

Автоматически собирает HTTP метрики для всех запросов. Настраивается через `httpMetrics` в `PrometheusModuleOptions`. Поддерживает игнорирование путей и методов.

### Декораторы

- **@TrackDuration** - автоматически измеряет время выполнения метода
- **@TrackCounter** - автоматически подсчитывает вызовы метода
- **@PrometheusMetric** - определяет кастомную метрику для метода

### PrometheusClientModule (Global Module)

Помечен как `@Global()` - доступен во всех модулях без повторного импорта. Регистрация через `forRootAsync()` с `useFactory`. Интегрируется с `@willsoto/nestjs-prometheus` для экспорта метрик на `/metrics`. Экспортирует `PrometheusService`, `HttpMetricsService`, `KafkaMetricsService`, `AiMetricsService`, `MetricRegistry`.

## Типы метрик

- **Counter** - счетчик, увеличивается на 1 или больше
- **Histogram** - гистограмма для измерения распределения значений (например, время выполнения)
- **Gauge** - значение, которое может увеличиваться и уменьшаться
- **Summary** - суммарная метрика для вычисления квантилей

## Registry

Используется глобальный Registry от `prom-client` (`register`). Это гарантирует, что все метрики будут экспортироваться на `/metrics` endpoint через @willsoto/nestjs-prometheus. Все метрики регистрируются в одном Registry для централизованного экспорта.

## Использование

### Регистрация в AppModule

```typescript
import { Module } from '@nestjs/common';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { PrometheusClientModule } from '@makebelieve21213-packages/prometheus-client';

@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    PrometheusClientModule.forRootAsync<[ConfigService]>({
      useFactory: (configService: ConfigService) => ({
        path: configService.get('PROMETHEUS_METRICS_PATH') || '/metrics',
        defaultMetrics: configService.get('PROMETHEUS_DEFAULT_METRICS') !== 'false',
        httpMetrics: {
          enabled: true,
          ignorePaths: ['/metrics', '/health'],
          ignoreMethods: ['OPTIONS'],
        },
      }),
      inject: [ConfigService],
    }),
  ],
})
export class AppModule {}
```

### Подключение HTTP интерцептора

```typescript
import { APP_INTERCEPTOR } from '@nestjs/core';
import { PrometheusHttpInterceptor } from '@makebelieve21213-packages/prometheus-client';

@Module({
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: PrometheusHttpInterceptor,
    },
  ],
})
export class AppModule {}
```

### Использование специализированных сервисов

```typescript
import { Injectable } from '@nestjs/common';
import { HttpMetricsService, KafkaMetricsService, AiMetricsService } from '@makebelieve21213-packages/prometheus-client';

@Injectable()
export default class MyService {
  constructor(
    private readonly httpMetrics: HttpMetricsService,
    private readonly kafkaMetrics: KafkaMetricsService,
    private readonly aiMetrics: AiMetricsService,
  ) {}

  async handleRequest() {
    const startTime = Date.now();
    try {
      // Ваша логика
      const duration = Date.now() - startTime;
      this.httpMetrics.recordHttpRequest('GET', '/api/users', 200, duration);
    } catch (error) {
      const duration = Date.now() - startTime;
      this.httpMetrics.recordHttpError('GET', '/api/users', 500, duration, error);
    }
  }
}
```

### Использование декораторов

```typescript
import { Injectable } from '@nestjs/common';
import { TrackDuration, TrackCounter } from '@makebelieve21213-packages/prometheus-client';

@Injectable()
export default class MyService {
  @TrackDuration('my_method_duration_seconds', { service: 'my-service' })
  @TrackCounter('my_method_calls_total', { service: 'my-service' })
  async myMethod() {
    // Ваша логика
  }
}
```

### Использование базового PrometheusService

```typescript
import { Injectable } from '@nestjs/common';
import { PrometheusService } from '@makebelieve21213-packages/prometheus-client';

@Injectable()
export default class MetricsService {
  private readonly httpRequestCounter: Counter;

  constructor(private readonly prometheusService: PrometheusService) {
    this.httpRequestCounter = this.prometheusService.createCounter({
      name: 'http_requests_total',
      help: 'Total number of HTTP requests',
      labelNames: ['method', 'route', 'status'],
    });
  }
}
```

## Важные детали реализации

### Global Module
- PrometheusClientModule помечен как `@Global()`
- Регистрируется один раз в AppModule
- Доступен во всех модулях без повторного импорта

### Глобальный Registry
- Используется глобальный Registry от `prom-client` (`register`)
- Это гарантирует совместимость с @willsoto/nestjs-prometheus
- Все метрики автоматически экспортируются на `/metrics` endpoint

### Инициализация метрик
- Метрики создаются в конструкторе сервиса через `PrometheusService`
- Специализированные сервисы создают метрики в `onModuleInit()`
- Метрики регистрируются в глобальном Registry автоматически

### Экспорт метрик
- Метрики автоматически экспортируются на `/metrics` endpoint через @willsoto/nestjs-prometheus
- Endpoint настраивается через `path` в `PrometheusModuleOptions`
- По умолчанию: `/metrics`

### HTTP Интерцептор
- Автоматически собирает метрики для всех HTTP запросов
- Настраивается через `httpMetrics` в `PrometheusModuleOptions`
- Поддерживает игнорирование путей и методов через `ignorePaths` и `ignoreMethods`

## Экспорты (index.ts)

Пакет экспортирует:
- `PrometheusClientModule` (default export)
- `PrometheusService`
- `HttpMetricsService`
- `KafkaMetricsService`
- `AiMetricsService`
- `PrometheusHttpInterceptor`
- `MetricRegistry`
- Декораторы: `TrackDuration`, `TrackCounter`, `PrometheusMetric`
- Утилиты: `createMetricTimer`, `wrapWithMetrics`, `extractHttpLabels`, `createHttpMetricsSet`, `createKafkaMetricsSet`, `createDatabaseMetricsSet`
- Типы: `PrometheusModuleOptions`, `PrometheusClientContract`, `HttpMetricsSet`, `KafkaMetricsSet`, `DatabaseMetricsSet`

## Типичные сценарии использования

### Базовое использование
1. Импортировать `PrometheusClientModule.forRootAsync()` в AppModule
2. Подключить `PrometheusHttpInterceptor` как `APP_INTERCEPTOR` (опционально)
3. Инжектировать `PrometheusService` или специализированные сервисы в сервисы
4. Использовать метрики через методы `inc()`, `observe()`, `set()` и т.д.

### С автоматическим сбором HTTP метрик
1. Подключить `PrometheusHttpInterceptor` как `APP_INTERCEPTOR`
2. Настроить `httpMetrics` в конфигурации модуля
3. Метрики будут собираться автоматически

### С декораторами
1. Использовать `@TrackDuration` и `@TrackCounter` для автоматического трекинга
2. Использовать `@PrometheusMetric` для кастомных метрик

## Важные замечания

1. **Global Module**: Регистрируется один раз в AppModule
2. **Глобальный Registry**: Используется глобальный Registry от prom-client
3. **Автоматический экспорт**: Метрики автоматически экспортируются на `/metrics` endpoint
4. **HTTP Интерцептор**: Автоматически собирает метрики для всех HTTP запросов
5. **Специализированные сервисы**: Упрощают работу с метриками в приложении
6. **Декораторы**: Упрощают трекинг методов

## Зависимости

- `@nestjs/common` - NestJS decorators и интерфейсы
- `@willsoto/nestjs-prometheus` - интеграция Prometheus с NestJS
- `prom-client` - клиент для Prometheus метрик
- `reflect-metadata` - для декораторов

### Peer
- `@nestjs/common` ^11.0.0
- `@willsoto/nestjs-prometheus` ^6.0.0
- `prom-client` ^15.0.0
- `reflect-metadata` ^0.1.13 || ^0.2.0
- `rxjs` ^7.8.0
